{"title":"Drilldown on Neuropsych Data with R","markdown":{"yaml":{"title":"Drilldown on Neuropsych Data with R","subtitle":"drilldown plot in highcharter","summary":"drilldown plot in highcharter trying to post","slug":"npsych-drilldown","authors":["admin"],"categories":["R"],"date":"2021-06-18","draft":false,"featured":true,"projects":[],"tags":[],"lastmod":"2021-06-18T18:11:39-07:00"},"headingText":"Highcharter Drilldown Setup","containsRefs":false,"markdown":"\n\n\n### R Markdown chunk options\n\n```{r setup, include = FALSE, echo = FALSE}\nlibrary(blogdown)\nlibrary(rmarkdown)\nlibrary(revealjs)\nlibrary(xaringan)\nlibrary(xaringanExtra)\nlibrary(xaringanthemer)\nlibrary(dataui)\nlibrary(reactable)\nlibrary(tidyverse)\nlibrary(highcharter)\nlibrary(htmlwidgets)\nlibrary(widgetframe)\nlibrary(crosstalk)\nlibrary(manipulateWidget)\n# Chunk options\nknitr::opts_chunk$set(collapse = TRUE, class.source = c(\"aside\", \"img\", \"drilld\", \"rect\"))\nprint(getwd())\nprint(here::here())\nreadRenviron(\"./Renviron\")\n```\n\n### Load libraries\n\n```{css, echo=FALSE}\naside {\n  margin-left: 100%;\n  position: absolute;\n}\n```\n\n```{css, echo=FALSE}\nimg {\n  width: 100vw;\n  margin-left: calc(50% - 50vw);\n}\n```\n\n```{css, echo=FALSE}\nrect[Attributes Style] {\n    fill: transparent;\n    x: 0;\n    y: 0;\n    width: 800;\n    height: 500;\n    rx: 0;\n    ry: 0;\n}\n```\n\n### Import data\n\n```{r echo=F, include=FALSE}\n# patient\npatient <- \"biggie\"\n# path to files\ndata_path <- (\"~/brainworkup.io/content/post/2021-06-18-npsych-drilldown/csv\")\n# get file names of .csv files\nfiles <- dir(data_path, pattern = \"*.csv\")\n# read into env\n\nneuropsych <-\n  files %>%\n  purrr::set_names() %>%\n  purrr::map_df(~ readr::read_csv(file.path(data_path, .)),\n    na = c(\"\", \"NA\", \"--\", \"-\"),\n    .id = \"filename\"\n  ) %>%\n  dplyr::filter(!is.na(percentile)) %>%\n  dplyr::distinct() %>%\n  dplyr::mutate(z = qnorm(percentile / 100))\n\nneuropsych <- neuropsych %>%\n  dplyr::mutate(domain = forcats::as_factor(domain)) %>%\n  dplyr::mutate(subdomain = forcats::as_factor(subdomain)) %>%\n  dplyr::mutate(narrow = forcats::as_factor(narrow)) %>%\n  # dplyr::mutate(verbal = forcats::as_factor(verbal)) %>%\n  dplyr::mutate(pass = forcats::as_factor(pass)) %>%\n  dplyr::mutate(timed = forcats::as_factor(timed))\n```\n\n## Drilldown using percentiles\n\n```{r echo=F}\nncog <- neuropsych %>%\n  group_by(domain) %>%\n  summarize(Pct = mean(percentile))\n\nncog <- arrange(ncog, desc(Pct))\n\n## Level 1\nncogL1status <- tibble(\n  name = ncog$domain,\n  y = ncog$Pct,\n  drilldown = tolower(name)\n)\n\n## Level 2\nncogL2drill <- lapply(unique(neuropsych$domain), function(x_level) {\n  ncog2 <- subset(neuropsych, neuropsych$domain %in% x_level)\n  # ncog2 <- neuropsych[neuropsych$domain == x_level,]\n  ncog2 <- ncog2 %>%\n    group_by(subdomain) %>%\n    summarize(Pct = mean(percentile))\n  ncog2 <- arrange(ncog2, desc(Pct)) ### CHECK\n  ncogL2status <- tibble(name = ncog2$subdomain, y = ncog2$Pct, drilldown = tolower(paste(x_level, name, sep = \"_\")))\n  list(id = tolower(x_level), type = \"column\", data = list_parse(ncogL2status))\n})\n\n## Level 3\nncogL3drill <- lapply(unique(neuropsych$domain), function(x_level) {\n  ncog2 <- subset(neuropsych, neuropsych$domain %in% x_level)\n  # ncog2 <- neuropsych[neuropsych$domain == x_level,]\n  lapply(unique(ncog2$subdomain), function(y_level) {\n    ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)\n    # ncog3 <- ncog2[ncog2$subdomain == y_level,]\n    ncog3 <- ncog3 %>%\n      group_by(narrow) %>%\n      summarize(Pct = mean(percentile))\n    ncog3 <- arrange(ncog3, desc(Pct))\n    ncogL3status <- tibble(name = ncog3$narrow, y = ncog3$Pct, drilldown = tolower(paste(x_level, y_level, name, sep = \"_\")))\n    list(id = tolower(paste(x_level, y_level, sep = \"_\")), type = \"column\", data = list_parse(ncogL3status))\n  })\n}) %>% unlist(recursive = FALSE)\n\n## Level 4\nncogL4drill <- lapply(unique(neuropsych$domain), function(x_level) {\n  ncog2 <- subset(neuropsych, neuropsych$domain %in% x_level)\n  # ncog2 <- neuropsych[neuropsych$domain == x_level,]\n  lapply(unique(ncog2$subdomain), function(y_level) {\n    ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)\n    # ncog3 <- ncog2[ncog2$subdomain == y_level,]\n    lapply(unique(ncog3$narrow), function(z_level) {\n      ncog4 <- subset(ncog3, ncog3$narrow %in% z_level)\n      # ncog4 <- ncog3[ncog3$narrow == z_level,]\n      ncog4 <- ncog4 %>%\n        group_by(scale) %>%\n        summarize(Pct = mean(percentile))\n      ncog4 <- arrange(ncog4, desc(Pct))\n      ncogL4status <- tibble(name = ncog4$scale, y = ncog4$Pct)\n      list(id = tolower(paste(x_level, y_level, z_level, sep = \"_\")), type = \"column\", data = list_parse2(ncogL4status))\n    })\n  }) %>%\n    unlist(recursive = FALSE)\n}) %>%\n  unlist(recursive = FALSE)\n```\n\n```{css, echo=FALSE}\n.drilld {\n  width: 100vw;\n  margin-left: calc(50% - 50vw);\n}\n```\n\n```{r drillp, fig.cap='Drilldown Neuropsych Pct', echo=F}\ncolors <-\n  c(\n    \"#058DC7\",\n    \"#50B432\",\n    \"#ED561B\",\n    \"#DDDF00\",\n    \"#24CBE5\",\n    \"#64E572\",\n    \"#FF9655\",\n    \"#FFF263\",\n    \"#6AF9C4\"\n  )\n\ncolors8 <-\n  c(\n    \"#058DC7\",\n    \"#50B432\",\n    \"#DDDF00\",\n    \"#24CBE5\",\n    \"#64E572\",\n    \"#FF9655\",\n    \"#FFF263\",\n    \"#6AF9C4\"\n  )\n\n## for Tooltip\n\nncogL1status <- ncogL1status %>%\n  dplyr::mutate(\n    rangep = case_when(\n      y >= 98 ~ \"Exceptionally High\",\n      y %in% 91:97 ~ \"Above Average\",\n      y %in% 75:90 ~ \"High-Average\",\n      y %in% 25:74 ~ \"Average\",\n      y %in% 9:24 ~ \"Low-Average\",\n      y %in% 2:8 ~ \"Below Average\",\n      y < 2 ~ \"Exceptionally Low\",\n      TRUE ~ as.character(y)\n    )\n  )\n\nx <- c(\"Name\", \"Score\", \"Range\")\ny <- c(\"{point.name}\", \"{point.y}\", \"{point.rangep}\")\ntt <- tooltip_table(x, y)\n\n# Create drilldown bar plot\n\nframeWidget(\n  highchart() %>%\n    hc_title(\n      text = patient,\n      style = list(fontSize = \"15px\")\n    ) %>%\n    hc_add_series(\n      ncogL1status,\n      type = \"bar\",\n      name = \"Neuropsychological Test Scores\",\n      hcaes(x = name, y = y, color = colors8)\n    ) %>%\n    hc_xAxis(\n      type = \"category\",\n      title = list(text = \"Domain\"),\n      categories = .$name\n    ) %>%\n    hc_yAxis(\n      title = list(text = \"Percentile\"),\n      labels = list(format = \"{value} â€°\")\n    ) %>%\n    hc_tooltip(\n      pointFormat = tt,\n      useHTML = TRUE,\n      valueDecimals = 0\n    ) %>%\n    hc_plotOptions(\n      series = list(\n        colorByPoint = TRUE,\n        allowPointSelect = TRUE,\n        dataLabels = TRUE\n      )\n    ) %>%\n    hc_drilldown(\n      allowPointDrilldown = TRUE,\n      series = c(ncogL2drill, ncogL3drill, ncogL4drill)\n    )\n)\n```\n\n## Drilldown using zScores\n\n```{r echo=F}\nlibrary(highcharter)\nlibrary(tidyverse)\n\nncogz <- neuropsych %>%\n  group_by(domain) %>%\n  summarize(zMean = mean(z))\n\nncogz <- arrange(ncogz, desc(zMean))\n\n## Level 1\nncogL1statusz <- tibble(\n  name = ncogz$domain,\n  y = ncogz$zMean,\n  drilldown = tolower(name)\n)\n\n## Level 2\nncogL2drillz <- lapply(unique(neuropsych$domain), function(x_level) {\n  ncog2z <- subset(neuropsych, neuropsych$domain %in% x_level)\n  # ncog2z <- neuropsych[neuropsych$domain == x_level,]\n  ncog2z <- ncog2z %>%\n    group_by(subdomain) %>%\n    summarize(zMean = mean(z))\n  ncog2z <- arrange(ncog2z, desc(zMean)) ### CHECK\n  ncogL2zstatus <- tibble(name = ncog2z$subdomain, y = ncog2z$zMean, drilldown = tolower(paste(x_level, name, sep = \"_\")))\n  list(id = tolower(x_level), type = \"column\", data = list_parse(ncogL2zstatus))\n})\n\n## Level 3\nncogL3drillz <- lapply(unique(neuropsych$domain), function(x_level) {\n  ncog2z <- subset(neuropsych, neuropsych$domain %in% x_level)\n  # ncog2 <- neuropsych[neuropsych$domain == x_level,]\n  lapply(unique(ncog2z$subdomain), function(y_level) {\n    ncog3z <- subset(ncog2z, ncog2z$subdomain %in% y_level)\n    # ncog3 <- ncog2[ncog2$subdomain == y_level,]\n    ncog3z <- ncog3z %>%\n      group_by(narrow) %>%\n      summarize(zMean = mean(z))\n    ncog3z <- arrange(ncog3z, desc(zMean))\n    ncogL3zstatus <- tibble(name = ncog3z$narrow, y = ncog3z$zMean, drilldown = tolower(paste(x_level, y_level, name, sep = \"_\")))\n    list(id = tolower(paste(x_level, y_level, sep = \"_\")), type = \"column\", data = list_parse(ncogL3zstatus))\n  })\n}) %>% unlist(recursive = FALSE)\n\n## Level 4\nncogL4drillz <- lapply(unique(neuropsych$domain), function(x_level) {\n  ncog2z <- subset(neuropsych, neuropsych$domain %in% x_level)\n  # ncog2 <- neuropsych[neuropsych$domain == x_level,]\n  lapply(unique(ncog2z$subdomain), function(y_level) {\n    ncog3z <- subset(ncog2z, ncog2z$subdomain %in% y_level)\n    # ncog3 <- ncog2[ncog2$subdomain == y_level,]\n    lapply(unique(ncog3z$narrow), function(z_level) {\n      ncog4z <- subset(ncog3z, ncog3z$narrow %in% z_level)\n      # ncog4 <- ncog3[ncog3$narrow == z_level,]\n      ncog4z <- ncog4z %>%\n        group_by(scale) %>%\n        summarize(zMean = mean(z))\n      ncog4z <- arrange(ncog4z, desc(zMean))\n      ncogL4zstatus <- tibble(name = ncog4z$scale, y = ncog4z$zMean)\n      list(id = tolower(paste(x_level, y_level, z_level, sep = \"_\")), type = \"column\", data = list_parse2(ncogL4zstatus))\n    })\n  }) %>% unlist(recursive = FALSE)\n}) %>% unlist(recursive = FALSE)\n```\n\n```{r drillz, class.source=\"drilld\", fig.cap='Drilldown Neuropsych zScores', echo=F, out.width=\"100%\"}\ncolors <-\n  c(\n    \"#058DC7\",\n    \"#50B432\",\n    \"#ED561B\",\n    \"#DDDF00\",\n    \"#24CBE5\",\n    \"#64E572\",\n    \"#FF9655\",\n    \"#FFF263\",\n    \"#6AF9C4\"\n  )\n\ncolors8 <-\n  c(\n    \"#058DC7\",\n    \"#50B432\",\n    \"#DDDF00\",\n    \"#24CBE5\",\n    \"#64E572\",\n    \"#FF9655\",\n    \"#FFF263\",\n    \"#6AF9C4\"\n  )\n\n## for Tooltip\n\nncogL1statusz <- ncogL1statusz %>%\n  dplyr::mutate(\n    rangez = case_when(\n      y >= 2 ~ \"Exceptionally High\",\n      y %in% 1.3:1.9 ~ \"Above Average\",\n      y %in% 0.7:1.2 ~ \"High-Average\",\n      y %in% -0.7:0.6 ~ \"Average\",\n      y %in% -1.3:-0.6 ~ \"Low-Average\",\n      y %in% -2:-1.4 ~ \"Below Average\",\n      y < -2 ~ \"Exceptionally Low\",\n      TRUE ~ as.character(y)\n    )\n  )\n\nx <- c(\"Name\", \"Score\", \"Range\")\ny <- c(\"{point.name}\", \"{point.y}\", \"{point.rangez}\")\ntt <- tooltip_table(x, y)\n\n# Create drilldown bar plot\n\nframeWidget(\n  highchart() %>%\n    hc_title(\n      text = patient,\n      style = list(fontSize = \"15px\")\n    ) %>%\n    hc_add_series(\n      ncogL1statusz,\n      type = \"bar\",\n      name = \"Neuropsychological Test Scores\",\n      hcaes(x = name, y = y, color = colors8)\n    ) %>%\n    hc_xAxis(\n      type = \"category\",\n      title = list(text = \"Domain\"),\n      categories = .$name\n    ) %>%\n    hc_yAxis(\n      title = list(text = \"z-score\"),\n      labels = list(format = \"{value}\")\n    ) %>%\n    hc_tooltip(\n      pointFormat = tt,\n      useHTML = TRUE,\n      valueDecimals = 0\n    ) %>%\n    hc_plotOptions(\n      series = list(\n        colorByPoint = TRUE,\n        allowPointSelect = TRUE,\n        dataLabels = TRUE\n      )\n    ) %>%\n    hc_drilldown(\n      allowPointDrilldown = TRUE,\n      series = c(ncogL2drillz, ncogL3drillz, ncogL4drillz)\n    )\n)\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../../styles.css"],"toc":true,"output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.215","theme":"cosmo","title":"Drilldown on Neuropsych Data with R","subtitle":"drilldown plot in highcharter","summary":"drilldown plot in highcharter trying to post","slug":"npsych-drilldown","authors":["admin"],"categories":["R"],"date":"2021-06-18","draft":false,"featured":true,"projects":[],"tags":[],"lastmod":"2021-06-18T18:11:39-07:00"},"extensions":{"book":{"multiFile":true}}}}}